<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Progress Tracker</title>
  <script>
    window.SDGPT_SUPABASE_URL = "https://ierqzjceskrwyvzijfnz.supabase.co";
    window.SDGPT_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImllcnF6amNlc2tyd3l2emlqZm56Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MTM2MjMsImV4cCI6MjA3Njk4OTYyM30.u40LZWQ2SpwysyNzMuRHMN5_FHPrW8VCk-KhG9iqrVY";
  </script>
  <style>
    :root {
      --bg: #ffffff;
      --surface: #ffffff;
      --text: #1b1b1b;
      --muted: #5f6368;
      --accent: #1a73e8;
      font-family: "Roboto", "Segoe UI", system-ui, sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: clamp(16px, 4vw, 40px);
    }
    .shell {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    header {
      text-align: center;
    }
    header h1 {
      margin: 0;
      font-size: clamp(24px, 4vw, 32px);
      font-weight: 700;
    }
    header p {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 15px;
    }
    .status {
      margin: 0;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(15, 14, 32, 0.12);
      background: var(--surface);
      color: var(--muted);
      font-size: 14px;
      text-align: center;
    }
    .status.hidden { display: none; }
    .status.error { color: #c5221f; border-color: rgba(197, 34, 31, 0.22); background: #fff7f7; }
    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }
    .tabs button {
      border: 1px solid rgba(15, 14, 32, 0.12);
      border-radius: 14px;
      padding: 10px 0;
      background: rgba(26, 115, 232, 0.08);
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tabs button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .grid { display: flex; flex-direction: column; gap: 12px; }
    .card {
      background: var(--surface);
      border-radius: 16px;
      border: 1px solid rgba(15, 14, 32, 0.12);
      padding: clamp(14px, 2vw, 18px);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .card header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .card h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }
    .muted { color: var(--muted); font-size: 14px; }
    .pill {
      padding: 4px 12px;
      border-radius: 999px;
      background: rgba(26, 115, 232, 0.15);
      color: var(--accent);
      font-weight: 600;
    }
    ul.list {
      list-style: none;
      margin: 0;
      padding-left: 14px;
      border-left: 3px solid rgba(15, 14, 32, 0.12);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
    }
    .timeline-card {
      border-color: rgba(26, 115, 232, 0.35);
    }
    .timeline-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .username-badge {
      font-size: 16px;
      font-weight: 600;
      color: #0f172a;
    }
    .table-wrapper {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 10px;
      border: 1px solid rgba(15, 14, 32, 0.12);
    }
    table {
      width: 100%;
      min-width: 520px;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      text-align: left;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(15, 14, 32, 0.08);
      background: #fff;
    }
    th {
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <h1>Mission Progress</h1>
      <p>Live overview of user contributions and mission timeline.</p>
    </header>
    <p class="status" id="status">Initializing…</p>
    <div class="tabs">
      <button type="button" class="active" data-mode="users">By User</button>
      <button type="button" data-mode="missions">All Missions</button>
      <button type="button" data-mode="directory">User Directory</button>
    </div>
    <div id="view" class="grid"></div>
  </div>

  <script>
    const SUPABASE_URL = window.SDGPT_SUPABASE_URL;
    const SUPABASE_KEY = window.SDGPT_SUPABASE_ANON_KEY;
    const statusEl = document.getElementById('status');
    const viewEl = document.getElementById('view');
    const tabs = document.querySelectorAll('[data-mode]');
    let currentMode = 'users';
    let state = null;

    const formatDate = (value) => {
      try {
        return new Intl.DateTimeFormat(undefined, {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }).format(new Date(value));
      } catch { return value; }
    };

    if (!SUPABASE_URL || !SUPABASE_KEY) {
      statusEl.textContent = 'Please provide Supabase credentials.';
      statusEl.classList.add('error');
    } else {
      const restHeaders = { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` };
      async function fetchJson(view, query = '') {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/${view}${query}`, { headers: restHeaders });
        if (!response.ok) throw new Error(await response.text() || response.statusText);
        return response.json();
      }
      async function loadData() {
        const [users, records] = await Promise.all([
          fetchJson('users', '?select=id,username,displayname,email,points,created&order=points.desc'),
          fetchJson('records', '?select=r_user_id,r_points,r_mission_id,r_created,missions(m_name,m_type)')
        ]);
        const grouped = new Map();
        records.forEach((rec) => {
          const arr = grouped.get(rec.r_user_id) ?? [];
          arr.push(rec);
          grouped.set(rec.r_user_id, arr);
        });
        const usersWithRecords = users.map((user) => ({
          ...user,
          records: (grouped.get(user.id) ?? []).map((rec) => ({
            missionName: rec.missions?.m_name ?? rec.r_mission_id,
            missionType: rec.missions?.m_type ?? 'unknown',
            points: rec.r_points,
            created: rec.r_created
          })).sort((a, b) => new Date(b.created) - new Date(a.created))
        }));
        const timeline = records
          .map((rec) => ({
            missionName: rec.missions?.m_name ?? rec.r_mission_id,
            missionType: rec.missions?.m_type ?? 'unknown',
            points: rec.r_points,
            created: rec.r_created,
            userId: rec.r_user_id
          }))
          .sort((a, b) => new Date(b.created) - new Date(a.created));
        return { users: usersWithRecords, timeline, usersById: new Map(users.map((u) => [u.id, u])) };
      }
      function renderUsers(data) {
        viewEl.innerHTML = '';
        if (!data.users.length) {
          viewEl.textContent = 'No users found.';
          return;
        }
        data.users.forEach((user) => {
      const card = document.createElement('div');
      card.className = 'card';
      if ((user.points ?? 0) === 0) {
        card.style.borderColor = 'rgba(255, 99, 132, 0.4)';
        card.style.background = 'rgba(255, 241, 244, 0.7)';
      }
          const header = document.createElement('header');
          header.innerHTML = `<div><h3>${user.username || '(user)'}</h3><div class="muted">${user.displayname || ''}</div></div>`;
          const pill = document.createElement('div');
          pill.className = 'pill';
          pill.textContent = `${user.points ?? 0} pts`;
          header.append(pill);
          card.append(header);
          const list = document.createElement('ul');
          list.className = 'list';
          if (!user.records.length) {
            const li = document.createElement('li');
            li.textContent = 'No missions completed yet.';
            list.append(li);
          } else {
            user.records.forEach((record) => {
              const li = document.createElement('li');
              li.innerHTML = `<strong>${record.missionName}</strong> <span class="muted">(${record.missionType})</span> · ${record.points} pts · <span class="muted">${formatDate(record.created)}</span>`;
              list.append(li);
            });
          }
          card.append(list);
          viewEl.append(card);
        });
      }
      function renderTimeline(data) {
        viewEl.innerHTML = '';
        if (!data.timeline.length) {
          viewEl.textContent = 'No missions completed yet.';
          return;
        }
        data.timeline.forEach((mission) => {
          const card = document.createElement('div');
          card.className = 'card timeline-card';
          const user = data.usersById.get(mission.userId);
          card.innerHTML = `<header><div><h3>${mission.missionName}</h3><div class="muted">${mission.missionType}</div></div><div class="pill">${mission.points} pts</div></header>`;
          const meta = document.createElement('div');
          meta.className = 'timeline-meta';
          meta.innerHTML = `<span class="username-badge">${user?.username ?? 'unknown user'}</span><span class="muted">${formatDate(mission.created)}</span>`;
          card.append(meta);
          viewEl.append(card);
        });
      }
      function renderDirectory(data) {
        viewEl.innerHTML = '';
        if (!data.users.length) {
          viewEl.textContent = 'No users found.';
          return;
        }
        const card = document.createElement('div');
        card.className = 'card';
        const wrapper = document.createElement('div');
        wrapper.className = 'table-wrapper';
        const table = document.createElement('table');
        table.innerHTML = '<thead><tr><th>Name</th><th>Email</th><th>Points</th><th>Created</th></tr></thead>';
        const tbody = document.createElement('tbody');
        [...data.users]
          .sort((a, b) => new Date(b.created ?? 0) - new Date(a.created ?? 0))
          .forEach((user) => {
            const row = document.createElement('tr');
            if ((user.points ?? 0) === 0) {
              row.style.background = 'rgba(255, 241, 244, 0.8)';
            }
            row.innerHTML = `<td>${user.displayname || user.username || '(user)'}</td><td>${user.email ?? ''}</td><td>${user.points ?? 0}</td><td>${user.created ? formatDate(user.created) : ''}</td>`;
            tbody.append(row);
          });
        table.append(tbody);
        wrapper.append(table);
        card.append(wrapper);
        viewEl.append(card);
      }
      function render() {
        if (!state) return;
        if (currentMode === 'users') renderUsers(state);
        else if (currentMode === 'missions') renderTimeline(state);
        else renderDirectory(state);
      }
      tabs.forEach((tab) => tab.addEventListener('click', () => {
        currentMode = tab.dataset.mode;
        tabs.forEach((btn) => btn.classList.toggle('active', btn === tab));
        render();
      }));
      (async () => {
        try {
          statusEl.textContent = 'Loading data…';
          state = await loadData();
          statusEl.classList.add('hidden');
          render();
        } catch (error) {
          statusEl.textContent = `Failed to load data: ${error.message}`;
          statusEl.classList.add('error');
        }
      })();
    }
  </script>
</body>
</html>
